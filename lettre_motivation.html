<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>G√©n√©rateur de Lettre de Motivation - EmploiAvenir</title>
  <base href="/Red-Cross-HTML/">  <!-- AJOUTE CETTE LIGNE -->
  <meta name="description" content="G√©n√©rez une lettre de motivation personnalis√©e avec EmploiAvenir. Simple, rapide et efficace.">
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>
  <!-- HEADER (inchang√©) -->
  <header class="header" id="header">
    <div class="container flex justify-between items-center">
      <a href="index.html" class="logo" aria-label="Accueil EmploiAvenir"><span>Emploi</span>Avenir</a>
      <nav aria-label="Navigation principale">
        <ul class="nav-links" id="mainNavLinks">
          <li><a href="index.html"data-i18n="Home">Accueil</a></li>
          <li><a href="MonParcours.html" aria-current="page"data-i18n="Parcours">Mon Parcours</a></li>
          <li><a href="MesCandidature.html" data-i18n="Candidatures">Mes Candidatures</a></li>
          <li><a href="Partenaires.html" data-i18n="Partenaires">Nos partenaires</a></li>
          <li><a href="Documents.html" data-i18n="Documents">Mes documents</a></li>
          <li><a href="Profil.html" data-i18n="Profil">Profil</a></li>
        </ul>
      </nav>
      <button class="mobile-menu-btn" id="mobileMenuBtn" aria-label="Ouvrir le menu de navigation" aria-expanded="false" aria-controls="mainNavLinks">‚ò∞</button>
    </div>
  </header>
<select id="langSwitcher" aria-label="Choisir la langue">
  <option value="fr">üá´üá∑ Fran√ßais</option>
  <option value="en">üá¨üáß English</option>
  <option value="ar">üá∏üá¶ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
  <option value="uk">UK  —É–∫—Ä–∞—ó–Ω—Å—å–∫–∞ –º–æ–≤–∞</option>
</select>

  <main>
    <section class="container mt-8 mb-8" style="max-width:700px;"> 
      <header class="section-header text-center mb-6"> 
        <h1 data-i18n="generateur">G√©n√©rateur de Lettre de Motivation</h1>
        <p class="intro-text" data-i18n="Consigne LM">Remplissez ce formulaire pour obtenir une lettre personnalis√©e et professionnelle en quelques secondes.</p>
      </header>

      <form id="motivationForm" class="card p-6" autocomplete="on"> 
        <div class="form-grid form-grid-cols-2 gap-4"> 
            <div class="form-group">
              <label for="nom" data-i18n="labelName">Nom Pr√©nom</label>
              <input type="text" id="nom" name="nom" required placeholder="Ex : Marie Dupont">
            </div>
            <div class="form-group">
              <label for="email" data-i18n="labelEmail">Email <span aria-hidden="true" class="text-danger">*</span></label>
              <input type="email" id="email" name="email" required autocomplete="email" class="form-control" placeholder="Ex : marie.dupont@email.com">
            </div>
        </div>
        <div class="form-group">
          <label for="poste" data-i18n="labelPoste">Poste vis√© <span aria-hidden="true" class="text-danger">*</span></label>
          <input type="text" id="poste" name="poste" required class="form-control" placeholder="Ex : Assistant administratif">
        </div>
        <div class="form-group">
          <label for="entreprise" data-i18n="labelEntreprise">Nom de l‚Äôentreprise <span aria-hidden="true" class="text-danger">*</span></label>
          <input type="text" id="entreprise" name="entreprise" required class="form-control" placeholder="Ex : Entreprise Dupuis">
        </div>
        <div class="form-group">
          <label for="motivation_poste" data-i18n="labelMotivation">Pourquoi ce poste vous int√©resse-t-il ? <span aria-hidden="true" class="text-danger">*</span></label>
          <textarea id="motivation_poste" name="motivation_poste" required class="form-control" rows="4" placeholder="Exprimez votre motivation..."></textarea> 
        </div>
        <div class="form-group">
          <label for="valeur_ajoutee" data-i18n="labelValue"> Ce que vous pouvez apporter √† l‚Äôentreprise <span aria-hidden="true" class="text-danger">*</span></label>
          <textarea id="valeur_ajoutee" name="valeur_ajoutee" required class="form-control" rows="4" placeholder="Parlez de vos atouts, qualit√©s, exp√©riences..."></textarea> 
        </div>
        <button type="submit" class="btn btn-primary btn-large button-full mt-2" id="generateLetterBtn" data-i18n="generateBtn"> 
          <i class="fas fa-magic mr-2"></i> G√©n√©rer ma Lettre
        </button>
      </form>

      <div id="letterResultSection" class="mt-6" style="display:none;">
        <h2 class="section-title centered" data-i18n="VotreLM">Votre Lettre de Motivation</h2>
        <div id="resultat" class="card p-4 mb-4" style="white-space: pre-wrap; min-height: 200px; border: 1px solid var(--color-gray-light);">
        </div>

        <div class="form-navigation flex justify-between items-center">
          <button type="button" class="btn btn-outline" id="backToParcoursLetterBtn">
            <i class="fas fa-arrow-left mr-2" data-i18n="BackParcours"></i> Retour √† Mon Parcours
          </button>
          <button type="button" class="btn btn-primary" id="nextStepAfterLetterBtn" data-i18n="NextStep">
            √âtape Suivante : Recherche <i class="fas fa-arrow-right ml-2"></i>
          </button>
        </div>
      </div>

    </section>
  </main>
<div class="text-center mt-4">
  <button id="ttsBtn" class="btn btn-outline">
    <i class="fas fa-volume-up"></i> Lire le contenu
  </button>
</div>

  <footer class="footer">
    <div class="container text-center py-4"> 
      <p data-i18n="Credits">¬© 2024 EmploiAvenir. Tous droits r√©serv√©s.</p>
    </div>
  </footer>
  <div id="toast-container"></div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const motivationForm = document.getElementById('motivationForm');
        const generateLetterBtn = document.getElementById('generateLetterBtn');
        const letterResultOutput = document.getElementById('resultat');
        const letterResultSection = document.getElementById('letterResultSection'); // Conteneur pour r√©sultat + boutons

        // Nouveaux boutons de navigation post-g√©n√©ration
        const backToParcoursLetterBtn = document.getElementById('backToParcoursLetterBtn');
        const nextStepAfterLetterBtn = document.getElementById('nextStepAfterLetterBtn');

        // URL de la prochaine √©tape
        const NEXT_PAGE_URL = 'recherche-candidature.html'; // √Ä CR√âER

        // Fonction pour afficher les toasts (√† adapter si vous avez un module App.showToast)
        const showToast = (message, type = 'info', duration = 3000) => {
            const toastContainer = document.getElementById('toast-container');
            if (!toastContainer) return;
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`; // Assurez-vous que ces classes existent dans style.css
            toast.textContent = message;
            toastContainer.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, duration);
        };


        motivationForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Validation simple c√¥t√© client
            let isValid = true;
            motivationForm.querySelectorAll('[required]').forEach(input => {
                input.classList.remove('input-error'); // Nettoyer les erreurs pr√©c√©dentes
                const errorMsgSibling = input.parentNode.querySelector('.error-message');
                if (errorMsgSibling) errorMsgSibling.remove();

                if (!input.value.trim()) {
                    input.classList.add('input-error');
                    const error = document.createElement('span');
                    error.className = 'error-message';
                    error.textContent = 'Ce champ est requis.';
                    input.parentNode.appendChild(error);
                    isValid = false;
                }
            });

            if (!isValid) {
                showToast('Veuillez remplir tous les champs requis.', 'error');
                return;
            }

            letterResultOutput.innerHTML = '<div class="text-center p-4"><i class="fas fa-spinner fa-spin fa-2x text-primary"></i><p class="mt-2">G√©n√©ration en cours...</p></div>';
            letterResultSection.style.display = 'block'; // Afficher la section r√©sultat imm√©diatement
            generateLetterBtn.disabled = true;
            generateLetterBtn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> G√©n√©ration...`;

            const formData = new FormData(motivationForm);
            const data = Object.fromEntries(formData.entries());

            try {
                // REMPLACEZ par votre URL d'API r√©elle si diff√©rente
                const response = await fetch("http://localhost:3001/api/generer-lettre", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: 'Erreur serveur inconnue.' }));
                    throw new Error(errorData.message || `Erreur HTTP: ${response.status}`);
                }

                const json = await response.json();

                if (json.text) {
                    letterResultOutput.innerText = json.text; // Affiche le texte brut, conserve les retours √† la ligne
                    showToast('Lettre g√©n√©r√©e avec succ√®s !', 'success');
                    // Les boutons de navigation post-g√©n√©ration sont d√©j√† dans letterResultSection et deviennent visibles
                } else {
                    throw new Error('R√©ponse invalide de l‚ÄôAPI : texte manquant.');
                }
            } catch (error) {
                console.error("Erreur API:", error);
                letterResultOutput.innerHTML = `<div class="text-center p-4 text-destructive"><i class="fas fa-exclamation-triangle fa-2x"></i><p class="mt-2">Erreur lors de la g√©n√©ration: ${error.message}</p></div>`;
                showToast(`Erreur: ${error.message}`, 'error', 5000);
            } finally {
                generateLetterBtn.disabled = false;
                generateLetterBtn.innerHTML = `<i class="fas fa-magic mr-2"></i> G√©n√©rer ma Lettre`;
            }
        });

        // Fonction pour mettre √† jour le statut du parcours dans localStorage
        const updateParcoursStatusForNextStep = () => {
            try {
                let parcoursData = JSON.parse(localStorage.getItem('parcoursEmploiAvenir')) || {};
                parcoursData.etapes = parcoursData.etapes || Array(8).fill(null).map((_, i) => ({ id: `etape-${i}`, statut: 'locked' }));
                parcoursData.etapeActuelleIndex = parcoursData.etapeActuelleIndex || 0;

                // √âtape 1 (CV & LM) compl√©t√©e
                if(parcoursData.etapes[1]) {
                    parcoursData.etapes[1].statut = 'completed';
                    parcoursData.etapes[1].dateCompletion = new Date().toISOString();
                } else {
                     parcoursData.etapes[1] = { id: 'etape-1', statut: 'completed', dateCompletion: new Date().toISOString() };
                }


                // √âtape 2 (Recherche & Candidature) devient active
                if(parcoursData.etapes[2]) {
                    parcoursData.etapes[2].statut = 'active';
                } else {
                    parcoursData.etapes[2] = { id: 'etape-2', statut: 'active' };
                }


                parcoursData.etapeActuelleIndex = 2; // L'√©tape Recherche & Candidature est maintenant l'√©tape active
                parcoursData.derniereActivite = new Date().toISOString();

                localStorage.setItem('parcoursEmploiAvenir', JSON.stringify(parcoursData));
                console.log("G√©n√©rateur LM: Statut du parcours mis √† jour pour l'√©tape suivante.", parcoursData);
                return true;
            } catch (error) {
                console.error("G√©n√©rateur LM: Erreur lors de la mise √† jour du statut du parcours:", error);
                showToast("Erreur lors de la sauvegarde de votre progression.", "error");
                return false;
            }
        };

        // √âcouteur pour le bouton "√âtape Suivante"
        if (nextStepAfterLetterBtn) {
            nextStepAfterLetterBtn.addEventListener('click', () => {
                console.log("Clic sur '√âtape Suivante : Recherche'");
                if (updateParcoursStatusForNextStep()) {
                    window.location.href = NEXT_PAGE_URL;
                }
            });
        }

        // √âcouteur pour le bouton "Retour √† Mon Parcours"
        if (backToParcoursLetterBtn) {
            backToParcoursLetterBtn.addEventListener('click', () => {
                console.log("Clic sur 'Retour √† Mon Parcours'");
                // Optionnel: Mettre √† jour le statut si on consid√®re que g√©n√©rer une lettre valide l'√©tape.
                // Si l'utilisateur n'a pas cliqu√© sur "√âtape Suivante",
                // on pourrait juste le renvoyer √† MonParcours sans changer l'√©tape active,
                // ou consid√©rer que l'√©tape CV/LM est en cours mais pas "valid√©e" pour passer √† la suivante.
                // Pour l'instant, on ne met √† jour le statut que via "√âtape Suivante".
                window.location.href = 'MonParcours.html';
            });
        }
    });
  </script>
  <script src="langue.js"></script>
  <script src= "texttospeech.js"> </script>
</body>
</html>