<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Générateur de Lettre de Motivation - EmploiAvenir</title>
  <meta name="description" content="Générez une lettre de motivation personnalisée avec EmploiAvenir. Simple, rapide et efficace.">
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>
  <!-- HEADER (inchangé) -->
  <header class="header" id="header">
    <div class="container flex justify-between items-center">
      <a href="index.html" class="logo" aria-label="Accueil EmploiAvenir"><span>Emploi</span>Avenir</a>
      <nav aria-label="Navigation principale">
        <ul class="nav-links" id="mainNavLinks">
          <li><a href="index.html">Accueil</a></li>
          <li><a href="MonParcours.html" class="active" aria-current="page">Mon Parcours</a></li>
          <li><a href="MesCandidature.html">Mes Candidatures</a></li>
          <li><a href="Partenaires.html">Nos partenaires</a></li>
          <li><a href="Documents.html">Mes documents</a></li>
          <li><a href="Profil.html">Profil</a></li>
        </ul>
      </nav>
      <button class="mobile-menu-btn" id="mobileMenuBtn" aria-label="Ouvrir le menu de navigation" aria-expanded="false" aria-controls="mainNavLinks">☰</button>
    </div>
  </header>

  <main>
    <section class="container mt-8 mb-8" style="max-width:700px;"> 
      <header class="section-header text-center mb-6"> 
        <h1>Générateur de Lettre de Motivation</h1>
        <p class="intro-text">Remplissez ce formulaire pour obtenir une lettre personnalisée et professionnelle en quelques secondes.</p>
      </header>

      <form id="motivationForm" class="card p-6" autocomplete="on"> 
        <div class="form-grid form-grid-cols-2 gap-4"> 
            <div class="form-group">
              <label for="nom">Nom Prénom <span aria-hidden="true" class="text-danger">*</span></label>
              <input type="text" id="nom" name="nom" required autocomplete="name" class="form-control" placeholder="Ex : Marie Dupont">
            </div>
            <div class="form-group">
              <label for="email">Email <span aria-hidden="true" class="text-danger">*</span></label>
              <input type="email" id="email" name="email" required autocomplete="email" class="form-control" placeholder="Ex : marie.dupont@email.com">
            </div>
        </div>
        <div class="form-group">
          <label for="poste">Poste visé <span aria-hidden="true" class="text-danger">*</span></label>
          <input type="text" id="poste" name="poste" required class="form-control" placeholder="Ex : Assistant administratif">
        </div>
        <div class="form-group">
          <label for="entreprise">Nom de l’entreprise <span aria-hidden="true" class="text-danger">*</span></label>
          <input type="text" id="entreprise" name="entreprise" required class="form-control" placeholder="Ex : Entreprise Dupuis">
        </div>
        <div class="form-group">
          <label for="motivation_poste">Pourquoi ce poste vous intéresse-t-il ? <span aria-hidden="true" class="text-danger">*</span></label>
          <textarea id="motivation_poste" name="motivation_poste" required class="form-control" rows="4" placeholder="Exprimez votre motivation..."></textarea> {/* rows augmenté */}
        </div>
        <div class="form-group">
          <label for="valeur_ajoutee">Ce que vous pouvez apporter à l’entreprise <span aria-hidden="true" class="text-danger">*</span></label>
          <textarea id="valeur_ajoutee" name="valeur_ajoutee" required class="form-control" rows="4" placeholder="Parlez de vos atouts, qualités, expériences..."></textarea> {/* rows augmenté */}
        </div>
        <button type="submit" class="btn btn-primary btn-large button-full mt-2" id="generateLetterBtn"> 
          <i class="fas fa-magic mr-2"></i> Générer ma Lettre
        </button>
      </form>

      <div id="letterResultSection" class="mt-6" style="display:none;">
        <h2 class="section-title centered">Votre Lettre de Motivation</h2>
        <div id="resultat" class="card p-4 mb-4" style="white-space: pre-wrap; min-height: 200px; border: 1px solid var(--color-gray-light);">
        </div>

        <div class="form-navigation flex justify-between items-center">
          <button type="button" class="btn btn-outline" id="backToParcoursLetterBtn">
            <i class="fas fa-arrow-left mr-2"></i> Retour à Mon Parcours
          </button>
          <button type="button" class="btn btn-primary" id="nextStepAfterLetterBtn">
            Étape Suivante : Recherche <i class="fas fa-arrow-right ml-2"></i>
          </button>
        </div>
      </div>

    </section>
  </main>

  <footer class="footer">
    <div class="container text-center py-4"> 
      <p>© 2024 EmploiAvenir. Tous droits réservés.</p>
    </div>
  </footer>
  <div id="toast-container"></div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const motivationForm = document.getElementById('motivationForm');
        const generateLetterBtn = document.getElementById('generateLetterBtn');
        const letterResultOutput = document.getElementById('resultat');
        const letterResultSection = document.getElementById('letterResultSection'); // Conteneur pour résultat + boutons

        // Nouveaux boutons de navigation post-génération
        const backToParcoursLetterBtn = document.getElementById('backToParcoursLetterBtn');
        const nextStepAfterLetterBtn = document.getElementById('nextStepAfterLetterBtn');

        // URL de la prochaine étape
        const NEXT_PAGE_URL = 'recherche-candidature.html'; // À CRÉER

        // Fonction pour afficher les toasts (à adapter si vous avez un module App.showToast)
        const showToast = (message, type = 'info', duration = 3000) => {
            const toastContainer = document.getElementById('toast-container');
            if (!toastContainer) return;
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`; // Assurez-vous que ces classes existent dans style.css
            toast.textContent = message;
            toastContainer.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, duration);
        };


        motivationForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Validation simple côté client
            let isValid = true;
            motivationForm.querySelectorAll('[required]').forEach(input => {
                input.classList.remove('input-error'); // Nettoyer les erreurs précédentes
                const errorMsgSibling = input.parentNode.querySelector('.error-message');
                if (errorMsgSibling) errorMsgSibling.remove();

                if (!input.value.trim()) {
                    input.classList.add('input-error');
                    const error = document.createElement('span');
                    error.className = 'error-message';
                    error.textContent = 'Ce champ est requis.';
                    input.parentNode.appendChild(error);
                    isValid = false;
                }
            });

            if (!isValid) {
                showToast('Veuillez remplir tous les champs requis.', 'error');
                return;
            }

            letterResultOutput.innerHTML = '<div class="text-center p-4"><i class="fas fa-spinner fa-spin fa-2x text-primary"></i><p class="mt-2">Génération en cours...</p></div>';
            letterResultSection.style.display = 'block'; // Afficher la section résultat immédiatement
            generateLetterBtn.disabled = true;
            generateLetterBtn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> Génération...`;

            const formData = new FormData(motivationForm);
            const data = Object.fromEntries(formData.entries());

            try {
                // REMPLACEZ par votre URL d'API réelle si différente
                const response = await fetch("http://localhost:3001/api/generer-lettre", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: 'Erreur serveur inconnue.' }));
                    throw new Error(errorData.message || `Erreur HTTP: ${response.status}`);
                }

                const json = await response.json();

                if (json.text) {
                    letterResultOutput.innerText = json.text; // Affiche le texte brut, conserve les retours à la ligne
                    showToast('Lettre générée avec succès !', 'success');
                    // Les boutons de navigation post-génération sont déjà dans letterResultSection et deviennent visibles
                } else {
                    throw new Error('Réponse invalide de l’API : texte manquant.');
                }
            } catch (error) {
                console.error("Erreur API:", error);
                letterResultOutput.innerHTML = `<div class="text-center p-4 text-destructive"><i class="fas fa-exclamation-triangle fa-2x"></i><p class="mt-2">Erreur lors de la génération: ${error.message}</p></div>`;
                showToast(`Erreur: ${error.message}`, 'error', 5000);
            } finally {
                generateLetterBtn.disabled = false;
                generateLetterBtn.innerHTML = `<i class="fas fa-magic mr-2"></i> Générer ma Lettre`;
            }
        });

        // Fonction pour mettre à jour le statut du parcours dans localStorage
        const updateParcoursStatusForNextStep = () => {
            try {
                let parcoursData = JSON.parse(localStorage.getItem('parcoursEmploiAvenir')) || {};
                parcoursData.etapes = parcoursData.etapes || Array(8).fill(null).map((_, i) => ({ id: `etape-${i}`, statut: 'locked' }));
                parcoursData.etapeActuelleIndex = parcoursData.etapeActuelleIndex || 0;

                // Étape 1 (CV & LM) complétée
                if(parcoursData.etapes[1]) {
                    parcoursData.etapes[1].statut = 'completed';
                    parcoursData.etapes[1].dateCompletion = new Date().toISOString();
                } else {
                     parcoursData.etapes[1] = { id: 'etape-1', statut: 'completed', dateCompletion: new Date().toISOString() };
                }


                // Étape 2 (Recherche & Candidature) devient active
                if(parcoursData.etapes[2]) {
                    parcoursData.etapes[2].statut = 'active';
                } else {
                    parcoursData.etapes[2] = { id: 'etape-2', statut: 'active' };
                }


                parcoursData.etapeActuelleIndex = 2; // L'étape Recherche & Candidature est maintenant l'étape active
                parcoursData.derniereActivite = new Date().toISOString();

                localStorage.setItem('parcoursEmploiAvenir', JSON.stringify(parcoursData));
                console.log("Générateur LM: Statut du parcours mis à jour pour l'étape suivante.", parcoursData);
                return true;
            } catch (error) {
                console.error("Générateur LM: Erreur lors de la mise à jour du statut du parcours:", error);
                showToast("Erreur lors de la sauvegarde de votre progression.", "error");
                return false;
            }
        };

        // Écouteur pour le bouton "Étape Suivante"
        if (nextStepAfterLetterBtn) {
            nextStepAfterLetterBtn.addEventListener('click', () => {
                console.log("Clic sur 'Étape Suivante : Recherche'");
                if (updateParcoursStatusForNextStep()) {
                    window.location.href = NEXT_PAGE_URL;
                }
            });
        }

        // Écouteur pour le bouton "Retour à Mon Parcours"
        if (backToParcoursLetterBtn) {
            backToParcoursLetterBtn.addEventListener('click', () => {
                console.log("Clic sur 'Retour à Mon Parcours'");
                // Optionnel: Mettre à jour le statut si on considère que générer une lettre valide l'étape.
                // Si l'utilisateur n'a pas cliqué sur "Étape Suivante",
                // on pourrait juste le renvoyer à MonParcours sans changer l'étape active,
                // ou considérer que l'étape CV/LM est en cours mais pas "validée" pour passer à la suivante.
                // Pour l'instant, on ne met à jour le statut que via "Étape Suivante".
                window.location.href = 'MonParcours.html';
            });
        }
    });
  </script>
</body>
</html>